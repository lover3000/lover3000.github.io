<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o L·ªô Tr√¨nh</title>
    <link href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@700&family=Nunito:wght@400;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            background-color: #fdcdcd;
            font-family: 'Nunito', sans-serif;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2 {
            font-family: 'Amatic SC', cursive;
            text-align: center;
            color: #d32f2f;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 2rem;
            border-bottom: 2px dashed #fdcdcd;
            padding-bottom: 10px;
            margin-top: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-family: inherit;
            font-size: 16px;
            box-sizing: border-box;
        }

        input:focus {
            border-color: #ff4081;
            outline: none;
        }

        .row {
            display: flex;
            gap: 15px;
        }

        .col {
            flex: 1;
        }

        /* Style cho danh s√°ch ƒë·ªãa ƒëi·ªÉm */
        .place-item {
            background: #fff0f0;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            position: relative;
            border: 1px solid #ffcdd2;
        }

        .btn-remove {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff5252;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-add {
            width: 100%;
            padding: 10px;
            background: #fff;
            border: 2px dashed #aaa;
            color: #aaa;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-add:hover {
            border-color: #ff4081;
            color: #ff4081;
        }

        .btn-submit {
            display: block;
            width: 100%;
            padding: 15px;
            background: #1976D2;
            color: white;
            font-family: 'Amatic SC', cursive;
            font-size: 28px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 30px;
            transition: transform 0.2s;
        }

        .btn-submit:hover {
            transform: scale(1.02);
            background: #1565C0;
        }

        .preview-box {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 10px;
            display: none;
            /* ·∫®n m·∫∑c ƒë·ªãnh */
            word-break: break-all;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Thi·∫øt K·∫ø Chuy·∫øn ƒêi</h1>
        <p style="text-align: center; color: #777;">ƒêi·ªÅn th√¥ng tin b√™n d∆∞·ªõi ƒë·ªÉ t·∫°o b·∫£n ƒë·ªì du l·ªãch</p>

        <form id="tripForm">
            <h2>1. Nh√¢n V·∫≠t</h2>
            <div class="row">
                <div class="col">
                    <label>Ng∆∞·ªùi l√°i</label>
                    <input type="text" id="driverName" value="Anh" placeholder="T√™n">
                    <select id="driverFace" style="margin-top: 5px;">
                    </select>
                </div>
                <div class="col">
                    <label>Ng∆∞·ªùi ng·ªìi sau</label>
                    <input type="text" id="passName" value="Em" placeholder="T√™n">
                    <select id="passFace" style="margin-top: 5px;">
                    </select>
                </div>
            </div>

            <h2>2. L·ªùi Nh·∫Øn</h2>
            <div class="form-group">
                <label>Ti√™u ƒë·ªÅ (ƒê·∫ßu trang)</label>
                <input type="text" id="headerText" value="Cu·ªôn xu·ªëng ƒë·ªÉ ƒëi ch∆°i n√®!">
            </div>
            <div class="form-group">
                <label>L·ªùi k·∫øt (Cu·ªëi trang)</label>
                <input type="text" id="footerText" value="ƒêi ch∆°i th√¥i!">
            </div>

            <h2>3. C√°c ƒê·ªãa ƒêi·ªÉm</h2>
            <div id="placesContainer">
            </div>

            <button type="button" class="btn-add" onclick="addPlaceInput()">+ Th√™m ƒë·ªãa ƒëi·ªÉm m·ªõi</button>

            <h2>4. Nh·∫°c n·ªÅn</h2>
            <div class="form-group">
                <label>Ch·ªçn nh·∫°c c√≥ s·∫µn trong kho:</label>

                <select id="musicSelect" style="height: 50px; font-size: 16px; margin-bottom: 15px;">
                    <option value="">-- Kh√¥ng d√πng nh·∫°c --</option>
                </select>

                <div id="previewArea"
                    style="display: none; background: #f1f8e9; padding: 10px; border-radius: 10px; border: 1px dashed #8bc34a;">
                    <p style="margin: 0 0 5px 0; color: #558b2f; font-weight: bold; font-size: 0.9em;">üéß Nghe th·ª≠:</p>
                    <audio id="previewPlayer" controls style="width: 100%; height: 35px;"></audio>
                </div>
            </div>

            <button type="button" class="btn-submit" onclick="generateLink()">‚ú® T·∫†O & XEM B·∫¢N ƒê·ªí ‚ú®</button>

            <div id="resultArea" class="preview-box">
                <p><strong>Link c·ªßa b·∫°n:</strong></p>
                <a id="finalLink" href="#" target="_blank">Click v√†o ƒë√¢y ƒë·ªÉ m·ªü</a>
            </div>
        </form>
    </div>

    <script>
        const icons = ["üê®", "üêØ", "ü¶Å", "üêÆ", "üê∞", "üêª", "üêª‚Äç‚ùÑÔ∏è", "üêº", "ü¶ù", "üê∂", "üê±", "üê≠", "üêπ", "üê∑", "üê∫", "ü¶ä", "üê∏"];

        // M·∫∑c ƒë·ªãnh
        let places = [
            { name: "Nh√†", description: "ƒê√≥n ƒëi ch∆°i n√®" },
            { name: "ƒÇn u·ªëng", description: "ƒêi ƒÉn b√∫n b√≤" },
            { name: "C√¥ng vi√™n", description: "ƒêi d·∫°o m√°t" },
            { name: "Nh√†", description: "V·ªÅ ng·ªß" }
        ];

        const musicLibrary = [
            { name: "happy_bonbon", file: "/assets/bgm/happy_bonbon.mp3" },
            { name: "happy_guitar", file: "/assets/bgm/happy_guitar.mp3" },
            { name: "happy_piano", file: "/assets/bgm/happy_piano.mp3" },
            { name: "noi_nay_co_anh", file: "/assets/bgm/noi_nay_co_anh.mp3" },
            { name: "phonecert", file: "/assets/bgm/phonecert.mp3" },
            { name: "up_violin", file: "/assets/bgm/up_violin.mp3" },
            { name: "wibu_kiminoto", file: "/assets/bgm/wibu_kiminoto.mp3" },
            { name: "cute_kinchana", file: "/assets/bgm/cute_kinchana.mp3" },
            { name: "sad_vet_mua", file: "/assets/bgm/sad_vet_mua.mp3" }
        ];

        function init() {
            // 1. Render Select Box
            const driverSelect = document.getElementById('driverFace');
            const passSelect = document.getElementById('passFace');

            icons.forEach((icon, index) => {
                const option = `<option value="${index}">${icon} Con v·∫≠t ${index + 1}</option>`;
                driverSelect.innerHTML += option;
                passSelect.innerHTML += option;
            });
            driverSelect.value = 0;
            passSelect.value = 1;

            // 2. Render Input
            renderPlacesInputs();

            // 1. RENDER LIST NH·∫†C V√ÄO SELECT BOX
            const musicSelect = document.getElementById('musicSelect');
            musicLibrary.forEach(song => {
                const option = `<option value="${song.file}">${song.name}</option>`;
                musicSelect.innerHTML += option;
            });

            // 2. X·ª¨ L√ù S·ª∞ KI·ªÜN KHI CH·ªåN NH·∫†C (NGHE TH·ª¨)
            const previewArea = document.getElementById('previewArea');
            const previewPlayer = document.getElementById('previewPlayer');

            musicSelect.addEventListener('change', function () {
                const selectedPath = this.value;

                if (selectedPath) {
                    // C√≥ ch·ªçn b√†i -> Hi·ªán tr√¨nh ph√°t & Ch∆°i nh·∫°c
                    previewArea.style.display = 'block';
                    previewPlayer.src = selectedPath;
                    previewPlayer.volume = 0.5; // ƒê·ªÉ √¢m l∆∞·ª£ng v·ª´a ph·∫£i
                    previewPlayer.play().catch(e => console.log("Tr√¨nh duy·ªát ch·∫∑n autoplay, b·∫•m play th·ªß c√¥ng nh√©"));
                } else {
                    // Kh√¥ng ch·ªçn b√†i (ch·ªçn d√≤ng ƒë·∫ßu ti√™n) -> ·∫®n tr√¨nh ph√°t
                    previewArea.style.display = 'none';
                    previewPlayer.pause();
                    previewPlayer.src = "";
                }
            });
        }

        // --- H√ÄM M√É H√ìA AN TO√ÄN CHO URL (QUAN TR·ªåNG) ---
        function encodeData(obj) {
            // 1. Chuy·ªÉn Object -> JSON String
            const jsonStr = JSON.stringify(obj);
            // 2. M√£ h√≥a UTF-8 an to√†n cho ti·∫øng Vi·ªát/Emoji
            const base64 = btoa(unescape(encodeURIComponent(jsonStr)));
            // 3. Bi·∫øn ƒë·ªïi th√†nh URL-Safe Base64 (Thay + th√†nh -, / th√†nh _)
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }
        function getYouTubeID(url) {
            if (!url) return "";
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : "";
        }
        function renderPlacesInputs() {
            const container = document.getElementById('placesContainer');
            container.innerHTML = "";

            places.forEach((place, index) => {
                const html = `
                <div class="place-item">
                    <button type="button" class="btn-remove" onclick="removePlace(${index})">√ó</button>
                    <div class="form-group">
                        <label>ƒê·ªãa ƒëi·ªÉm ${index + 1}</label>
                        <input type="text" class="input-place-name" value="${place.name}" placeholder="T√™n ƒë·ªãa ƒëi·ªÉm">
                    </div>
                    <div class="form-group">
                        <input type="text" class="input-place-desc" value="${place.description || ''}" placeholder="M√¥ t·∫£">
                    </div>
                </div>
            `;
                container.innerHTML += html;
            });
        }

        function addPlaceInput() {
            saveCurrentInputValues(); // L∆∞u c√°i c≈© tr∆∞·ªõc khi th√™m
            places.push({ name: "", description: "" });
            renderPlacesInputs();
        }

        function removePlace(index) {
            if (places.length <= 2) {
                alert("C·∫ßn √≠t nh·∫•t 2 ƒë·ªãa ƒëi·ªÉm!");
                return;
            }
            saveCurrentInputValues();
            places.splice(index, 1);
            renderPlacesInputs();
        }

        function saveCurrentInputValues() {
            const nameInputs = document.querySelectorAll('.input-place-name');
            const descInputs = document.querySelectorAll('.input-place-desc');

            places = [];
            nameInputs.forEach((input, i) => {
                places.push({
                    name: input.value,
                    description: descInputs[i].value // ƒê·ªíNG NH·∫§T T√äN BI·∫æN L√Ä description
                });
            });
        }

        function generateLink() {
            saveCurrentInputValues(); // L∆∞u l·∫ßn cu·ªëi

            // L·ªçc b·ªè c√°c √¥ tr·ªëng
            const finalPlaces = places.filter(p => p.name.trim() !== "");

            if (finalPlaces.length < 2) {
                alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t 2 ƒë·ªãa ƒëi·ªÉm!");
                return;
            }
            const musicId = document.getElementById('musicSelect').value;

            const config = {
                driver: {
                    name: document.getElementById('driverName').value,
                    face: parseInt(document.getElementById('driverFace').value)
                },
                passenger: {
                    name: document.getElementById('passName').value,
                    face: parseInt(document.getElementById('passFace').value)
                },
                header: document.getElementById('headerText').value,
                footer: document.getElementById('footerText').value,
                places: finalPlaces,

                musicId: musicId,

                segmentHeight: 500,
                paddingTop: 300,
                paddingBottom: 300,
                svgWidth: 500
            };

            // G·ªåI H√ÄM M√É H√ìA M·ªöI
            const encoded = encodeData(config);

            // T·∫°o Link
            // L∆ØU √ù: S·ª≠a t√™n file 'index.html' th√†nh t√™n file b·∫£n ƒë·ªì th·ª±c t·∫ø c·ªßa b·∫°n
            const mapFileName = "index.html";
            const fullUrl = `${window.location.origin}?data=${encoded}`;

            // Hi·ªÉn th·ªã
            document.getElementById('resultArea').style.display = 'block';
            const linkTag = document.getElementById('finalLink');
            linkTag.href = fullUrl;
            linkTag.innerText = fullUrl;

            // M·ªü lu√¥n
            // window.open(fullUrl, '_blank'); 
        }

        init();
    </script>
</body>

</html>